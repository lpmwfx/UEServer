# Changelog

All notable changes to UEServer will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/).

## [Unreleased]

### Added - 2025-12-26

#### RPC Server (C++ Plugin)
- Created UE5 plugin structure in `rpc/`
  - `UEServer.uplugin` - Plugin descriptor with metadata
  - `UEServer.Build.cs` - Build configuration with dependencies (Sockets, Networking, Json, JsonUtilities)
  - `UEServer.h` - Public module header
  - `UEServerModule.cpp` - Module implementation with startup/shutdown lifecycle
  - `UEServerRPC.h` - RPC server interface
  - `UEServerRPC.cpp` - RPC server implementation

- Implemented TCP server with dynamic port allocation
  - Binds to `127.0.0.1:0` (OS assigns available port)
  - Writes `.ueserver/rpc.json` with runtime state (port, pid, started timestamp)
  - Cleans up `.ueserver/rpc.json` on shutdown
  - Runs in dedicated thread (`FRunnable` implementation)
  - Non-blocking client connection handling

- Implemented JSON RPC protocol
  - Request format: `{"id": "...", "op": "...", ...params}`
  - Response format: `{"id": "...", "op": "...", "ok": true/false, ...fields}`
  - Error handling for invalid JSON

- Implemented `ping` operation
  - Request: `{"id": "req-001", "op": "ping"}`
  - Response: `{"id": "req-001", "op": "ping", "ok": true, "version": "0.1.0"}`
  - Used for health checks and server discovery

#### Documentation
- Created `rpc/README.md`
  - Installation instructions (project plugin vs engine plugin)
  - Usage guide and RPC protocol documentation
  - Manual testing examples with netcat
  - Architecture diagram
  - Troubleshooting guide

- Created `TODO` file
  - Phase 1: RPC BRIDGE MVP task breakdown
  - Success criteria definition
  - Future phase planning

- Created `CHANGELOG` (this file)

- Created `TESTING.md`
  - Step-by-step manual testing guide
  - Automated test script for RPC server
  - Success criteria and common issues
  - Integration with UETRAIL test project

- Created `.gitignore`
  - Exclude `.ueserver/` runtime state directory
  - Standard Python and IDE exclusions

#### Testing Setup
- Installed UEServer plugin in UETRAIL project (`/home/lpm/REPO/UETRAIL`)
  - Copied plugin to `Plugins/UEServer/`
  - Enabled in `UETRAIL.uproject`
  - Ready for manual testing with UE5

### Technical Details

**Port Discovery Mechanism:**
- RPC server binds to port 0 for dynamic allocation
- OS assigns available port (no conflicts between multiple UE5 instances)
- Runtime state written to `.ueserver/rpc.json`:
  ```json
  {
    "port": 45231,
    "pid": 12345,
    "started": "2025-12-26T10:30:00Z"
  }
  ```
- Bridge CLI reads this file from CWD to discover server port
- Stale file detection via PID validation

**Security:**
- Server always binds to localhost (127.0.0.1) only
- No external network exposure
- Future: TLS and authentication support planned

**Compatibility:**
- Unreal Engine 5.3+
- Platforms: Windows, Linux, macOS

### Status

**Completed:**
- âœ… UE5 plugin structure
- âœ… TCP server with dynamic port allocation
- âœ… JSON RPC protocol
- âœ… Ping operation
- âœ… Runtime state management (.ueserver/rpc.json)

### Added - 2025-12-26 (Session 2)

#### Bridge CLI (Python with mypy)
- Created Python bridge CLI structure in `bridge/`
  - `pyproject.toml` - Package configuration with setuptools, mypy, ruff
  - `ue_bridge/` package with clean module structure
  - Entry point: `ue-bridge` CLI command and `python -m ue_bridge`

- Implemented port discovery (`port_discovery.py`)
  - Reads `.ueserver/rpc.json` from current working directory
  - Validates JSON format and required fields (port, pid, started)
  - PID validation to detect stale port files (via `os.kill(pid, 0)`)
  - Clear error messages for all failure modes

- Implemented TCP client (`tcp_client.py`)
  - Async TCP connection using `asyncio.open_connection()`
  - Line-based JSON protocol (newline-delimited)
  - Request format: `{"id": "...", "op": "...", ...params}\n`
  - Response parsing with timeout and error handling
  - Connection cleanup (graceful close)

- Implemented tool system (`tools.py`)
  - Tool registry pattern (same as BlenderServer)
  - `ue.ping` tool for health checks
  - Extensible for future tools (UI inspection, control)

- Implemented CLI interface (`cli.py`)
  - CLI mode: `ue-bridge ue.ping`
  - Stdio mode: `echo '{"tool":"ue.ping","args":{}}' | ue-bridge`
  - Automatic port discovery on startup
  - Key=value argument parsing
  - Type auto-detection (bool, int, float, string)
  - Help text with examples

- Type safety
  - Full mypy type annotations throughout
  - Type protocols for extensibility (`ToolHandler`)
  - TypedDict for structured data (`ToolContext`, `PortDiscoveryResult`, etc.)
  - Passes `mypy --strict` with zero issues

- Documentation
  - `bridge/README.md` with usage examples
  - Inline docstrings for all public functions
  - Protocol reference documentation

- Development setup
  - `.gitignore` for Python artifacts
  - `mypy.ini` with strict type checking
  - `.python-version` (3.11)
  - `requirements.txt` and `requirements-dev.txt`

### Technical Details - Bridge CLI

**Architecture:**
```
CLI Invocation â†’ Port Discovery â†’ TCP Client â†’ UE RPC Server
```

**Port Discovery Flow:**
1. Read `.ueserver/rpc.json` from CWD
2. Validate JSON structure and types
3. Check if PID is alive (detect crashed server)
4. Return port or error message

**TCP Protocol:**
- Line-based JSON (newline-delimited)
- Request: `{"id": "cli-abc123", "op": "ping"}\n`
- Response: `{"id": "cli-abc123", "op": "ping", "ok": true, "version": "0.1.0"}\n`

**Error Handling:**
- Port file not found â†’ "UE RPC server not running"
- Invalid JSON â†’ "Invalid JSON in rpc.json"
- Stale PID â†’ "Stale port file detected"
- Connection refused â†’ "Cannot reach UE RPC"
- Timeout â†’ "Timeout contacting UE RPC"

### Status

**Completed:**
- âœ… UE5 plugin structure
- âœ… TCP server with dynamic port allocation
- âœ… JSON RPC protocol
- âœ… Ping operation
- âœ… Runtime state management (.ueserver/rpc.json)
- âœ… Python bridge CLI structure
- âœ… Port discovery implementation
- âœ… TCP client implementation
- âœ… CLI tool (ue.ping)
- âœ… Type checking (mypy)

### Added - 2025-12-26 (Session 3 - Phase 1 Complete!)

#### Port Discovery Update
- Updated port discovery to read from `~/.ueserver/switchboard.json` (global)
  - Changed from `.ueserver/rpc.json` in project directory
  - Supports multiple UE5 instances running simultaneously
  - Matches instance by project path
  - Fallback to single instance if only one running

#### Health Check Feature
- Added `ue.health` tool with 500ms timeout
  - Fast health check before longer operations
  - Prevents infinite retry loops when server down
  - Returns `{"ok": true, "status": "healthy"}` or error

#### Timeout Configuration
- Added `--timeout=MS` CLI parameter
  - Configurable timeout for all operations
  - Default: 2000ms (2 seconds)
  - Example: `ue-bridge ue.ping --timeout=5000`

#### Testing & Validation
- Compiled UEServer plugin for UETRAIL project
  - Symlinked plugin from `/home/lpm/REPO/UEServer/rpc` to UETRAIL
  - Built with UE 5.7.1 build system
  - Plugin loads successfully in editor

- End-to-end testing completed âœ…
  - UE5 server starts on dynamic port (33051)
  - `~/.ueserver/switchboard.json` created with instance info
  - Raw TCP test: `echo '{"id":"test","op":"ping"}' | nc 127.0.0.1 33051` âœ…
  - Bridge ping: `ue-bridge ue.ping` âœ…
  - Bridge health: `ue-bridge ue.health` âœ…
  - Custom timeout: `ue-bridge ue.ping --timeout=5000` âœ…

#### Documentation
- Updated CLI help text with new features
- Updated port discovery documentation
- Created `doc/DONE` to track completed work

### Status - Phase 1: RPC BRIDGE MVP âœ…

**All Success Criteria Met:**
1. âœ… UE5 plugin starts TCP server on dynamic port
2. âœ… `~/.ueserver/switchboard.json` is created with correct port info
3. âœ… Bridge CLI can discover port and connect
4. âœ… `ue-bridge ue.ping` returns successful response
5. âœ… Error handling works (server down, stale files)
6. âœ… `ue-bridge ue.health` provides fast health checks (500ms timeout)
7. âœ… Custom timeout support with --timeout parameter

**Phase 1 Complete!** ðŸŽ‰

### Next: Phase 2 - MCP Integration

**Goals:**
- Create MCP adapter wrapping bridge CLI
- Define MCP tools (ue_ping, ue_health)
- Enable Claude Code integration
- Reference BlenderServer MCP implementation

---

**Contributors**: TwistedBrain and Claude Sonnet 4.5
